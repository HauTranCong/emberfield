# Combat System - Enemy & Player Interaction

## Tá»•ng quan

Há»‡ thá»‘ng combat trong Emberfield sá»­ dá»¥ng **Hitbox/Hurtbox pattern** Ä‘á»ƒ xá»­ lÃ½ damage giá»¯a Player vÃ  Enemy. Äiá»u nÃ y tÃ¡ch biá»‡t hoÃ n toÃ n logic damage ra khá»i physics collision.

---

## SÆ¡ Ä‘á»“ tÆ°Æ¡ng tÃ¡c tá»•ng quan

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                              COMBAT INTERACTION OVERVIEW                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â•‘
â•‘     â”‚       PLAYER        â”‚                        â”‚        ENEMY        â”‚               â•‘
â•‘     â”‚   (CharacterBody2D) â”‚                        â”‚   (CharacterBody2D) â”‚               â•‘
â•‘     â”‚                     â”‚                        â”‚                     â”‚               â•‘
â•‘     â”‚  Layer 2: PLAYER    â”‚                        â”‚  Layer 3: ENEMY     â”‚               â•‘
â•‘     â”‚  Mask: WORLD|NPC|   â”‚                        â”‚  Mask: WORLD        â”‚               â•‘
â•‘     â”‚       INTERACTABLE  â”‚                        â”‚                     â”‚               â•‘
â•‘     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â•‘
â•‘                â”‚                                              â”‚                          â•‘
â•‘       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                 â•‘
â•‘       â”‚                 â”‚                            â”‚                 â”‚                 â•‘
â•‘       â–¼                 â–¼                            â–¼                 â–¼                 â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â•‘
â•‘  â”‚ HITBOX  â”‚       â”‚ HURTBOX â”‚                  â”‚ HITBOX  â”‚       â”‚ HURTBOX â”‚            â•‘
â•‘  â”‚ (Area2D)â”‚       â”‚ (Area2D)â”‚                  â”‚ (Area2D)â”‚       â”‚ (Area2D)â”‚            â•‘
â•‘  â”‚         â”‚       â”‚         â”‚                  â”‚         â”‚       â”‚         â”‚            â•‘
â•‘  â”‚ Layer 7 â”‚       â”‚ Layer 5 â”‚                  â”‚ Layer 8 â”‚       â”‚ Layer 6 â”‚            â•‘
â•‘  â”‚ PLAYER_ â”‚       â”‚ PLAYER_ â”‚                  â”‚ ENEMY_  â”‚       â”‚ ENEMY_  â”‚            â•‘
â•‘  â”‚ HITBOX  â”‚       â”‚ HURTBOX â”‚                  â”‚ HITBOX  â”‚       â”‚ HURTBOX â”‚            â•‘
â•‘  â”‚         â”‚       â”‚         â”‚                  â”‚         â”‚       â”‚         â”‚            â•‘
â•‘  â”‚ Mask: 6 â”‚       â”‚ Mask: 8 â”‚                  â”‚ Mask: 5 â”‚       â”‚ Mask: 7 â”‚            â•‘
â•‘  â”‚ ENEMY_  â”‚       â”‚ ENEMY_  â”‚                  â”‚ PLAYER_ â”‚       â”‚ PLAYER_ â”‚            â•‘
â•‘  â”‚ HURTBOX â”‚       â”‚ HITBOX  â”‚                  â”‚ HURTBOX â”‚       â”‚ HITBOX  â”‚            â•‘
â•‘  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜            â•‘
â•‘       â”‚                 â”‚                            â”‚                 â”‚                 â•‘
â•‘       â”‚                 â”‚         ATTACK             â”‚                 â”‚                 â•‘
â•‘       â”‚                 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚                 â•‘
â•‘       â”‚                 â”‚     Enemy hits Player      â”‚                 â”‚                 â•‘
â•‘       â”‚                 â”‚                            â”‚                 â”‚                 â•‘
â•‘       â”‚                      ATTACK                  â”‚                 â”‚                 â•‘
â•‘       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚                 â•‘
â•‘       â”‚              Player hits Enemy               â”‚                 â”‚                 â•‘
â•‘       â”‚                                              â”‚                 â”‚                 â•‘
â•‘                                                                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## Chi tiáº¿t Collision Layers

| Layer | TÃªn | Bit Value | MÃ´ táº£ |
|-------|-----|-----------|-------|
| 1 | WORLD | 1 | TÆ°á»ng, obstacles, terrain |
| 2 | PLAYER | 2 | Player body |
| 3 | ENEMY | 4 | Enemy body |
| 4 | NPC | 8 | NPC body |
| 5 | PLAYER_HURTBOX | 16 | VÃ¹ng Player nháº­n damage |
| 6 | ENEMY_HURTBOX | 32 | VÃ¹ng Enemy nháº­n damage |
| 7 | PLAYER_HITBOX | 64 | VÃ¹ng Player gÃ¢y damage |
| 8 | ENEMY_HITBOX | 128 | VÃ¹ng Enemy gÃ¢y damage |
| 9 | INTERACTABLE | 256 | Shop, chest, door |
| 10 | PICKUP | 512 | Items cÃ³ thá»ƒ nháº·t |

---

## Flow: Player táº¥n cÃ´ng Enemy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PLAYER ATTACKS ENEMY                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  1. Player nháº¥n attack                                                              â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ player.gd: _state_idle() hoáº·c _state_move()                      â”‚               â”‚
â”‚  â”‚   if Input.is_action_just_pressed("character_attack"):           â”‚               â”‚
â”‚  â”‚       _change_state(State.ATTACK)                                â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  2. Change state â†’ ATTACK                                                           â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ player.gd: _play_attack_animation()                              â”‚               â”‚
â”‚  â”‚   _enable_attack_hitbox()  â—„â”€â”€â”€ Báº­t hitbox ngay khi animation    â”‚               â”‚
â”‚  â”‚   anim.play("attack_" + direction)                               â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  3. Hitbox Ä‘Æ°á»£c báº­t vÃ  Ä‘áº·t vá»‹ trÃ­                                                   â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ player.gd: _enable_attack_hitbox()                               â”‚               â”‚
â”‚  â”‚   attack_hitbox.position = HITBOX_OFFSETS[direction]             â”‚               â”‚
â”‚  â”‚   attack_hitbox.rotation = last_dir.angle() + PI/2               â”‚               â”‚
â”‚  â”‚   attack_hitbox.activate()  â—„â”€â”€â”€ monitoring = true               â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  4. Collision detected: Player Hitbox â”€â”€â–º Enemy Hurtbox                             â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ hitbox_component.gd: _on_area_entered(area)                      â”‚               â”‚
â”‚  â”‚   if area is HurtboxComponent:                                   â”‚               â”‚
â”‚  â”‚       area.receive_damage(damage, knockback_force, global_pos)   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  5. Hurtbox nháº­n damage vÃ  emit signal                                              â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ hurtbox_component.gd: receive_damage(amount, knockback, from)    â”‚               â”‚
â”‚  â”‚   emit_signal("damage_received", amount, knockback, from)        â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  6. Skeleton xá»­ lÃ½ damage                                                           â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ skeleton.gd: _on_damage_received(amount, knockback, from)        â”‚               â”‚
â”‚  â”‚   health_component.take_damage(amount)                           â”‚               â”‚
â”‚  â”‚   anim.modulate = Color.RED  â—„â”€â”€â”€ Flash effect                   â”‚               â”‚
â”‚  â”‚   await 0.1s                                                     â”‚               â”‚
â”‚  â”‚   anim.modulate = Color.WHITE                                    â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  7. Health component cáº­p nháº­t vÃ  check death                                        â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ health_component.gd: take_damage(amount)                         â”‚               â”‚
â”‚  â”‚   current_health -= amount                                       â”‚               â”‚
â”‚  â”‚   emit_signal("health_changed", current_health, max_health)      â”‚               â”‚
â”‚  â”‚   if current_health <= 0:                                        â”‚               â”‚
â”‚  â”‚       emit_signal("died")                                        â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  8. Náº¿u cháº¿t â†’ Skeleton xá»­ lÃ½ death                                                 â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ skeleton.gd: _on_died()                                          â”‚               â”‚
â”‚  â”‚   _change_state(State.DEATH)                                     â”‚               â”‚
â”‚  â”‚   collision_layer = 0  â—„â”€â”€â”€ VÃ´ hiá»‡u hÃ³a collision                â”‚               â”‚
â”‚  â”‚   collision_mask = 0                                             â”‚               â”‚
â”‚  â”‚   await 1.0s                                                     â”‚               â”‚
â”‚  â”‚   queue_free()  â—„â”€â”€â”€ XÃ³a khá»i scene                              â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flow: Enemy táº¥n cÃ´ng Player

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ENEMY ATTACKS PLAYER                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  1. Enemy Ä‘uá»•i theo vÃ  Ä‘áº¿n gáº§n Player                                               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ skeleton.gd: _process_chase()                                    â”‚               â”‚
â”‚  â”‚   var distance = global_position.distance_to(player.global_pos)  â”‚               â”‚
â”‚  â”‚   if distance <= ATTACK_RANGE (30px):                            â”‚               â”‚
â”‚  â”‚       _change_state(State.ATTACK)                                â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  2. Enemy chuyá»ƒn sang state ATTACK                                                  â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ skeleton.gd: _change_state(State.ATTACK)                         â”‚               â”‚
â”‚  â”‚   velocity = Vector2.ZERO  â—„â”€â”€â”€ Dá»«ng di chuyá»ƒn                   â”‚               â”‚
â”‚  â”‚   _perform_attack()                                              â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  3. Báº¯t Ä‘áº§u attack vá»›i delay                                                        â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ skeleton.gd: _perform_attack()                                   â”‚               â”‚
â”‚  â”‚   last_direction = (player.global_pos - global_pos).normalized() â”‚               â”‚
â”‚  â”‚   _play_attack_animation()                                       â”‚               â”‚
â”‚  â”‚   await HITBOX_DELAY (0.8s)  â—„â”€â”€â”€ Delay Ä‘á»ƒ sync vá»›i animation    â”‚               â”‚
â”‚  â”‚   if current_state == State.ATTACK:                              â”‚               â”‚
â”‚  â”‚       _enable_attack_hitbox()                                    â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  4. Hitbox Ä‘Æ°á»£c báº­t sau delay                                                       â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ skeleton.gd: _enable_attack_hitbox()                             â”‚               â”‚
â”‚  â”‚   hitbox.position = HITBOX_OFFSETS[direction]                    â”‚               â”‚
â”‚  â”‚   hitbox.rotation = last_direction.angle() + PI/2                â”‚               â”‚
â”‚  â”‚   hitbox.activate()  â—„â”€â”€â”€ monitoring = true                      â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  5. Collision detected: Enemy Hitbox â”€â”€â–º Player Hurtbox                             â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ hitbox_component.gd: _on_area_entered(area)                      â”‚               â”‚
â”‚  â”‚   if area is HurtboxComponent:                                   â”‚               â”‚
â”‚  â”‚       area.receive_damage(15, 80.0, global_position)             â”‚               â”‚
â”‚  â”‚                          â–²    â–²                                  â”‚               â”‚
â”‚  â”‚                          â”‚    â””â”€â”€ knockback_force                â”‚               â”‚
â”‚  â”‚                          â””â”€â”€â”€â”€â”€â”€â”€ damage                         â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  6. Player Hurtbox emit signal                                                      â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ hurtbox_component.gd: receive_damage(15, 80.0, from_pos)         â”‚               â”‚
â”‚  â”‚   emit_signal("damage_received", 15, 80.0, from_pos)             â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  7. Player xá»­ lÃ½ damage vá»›i iframe check                                            â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ player.gd: _on_hurtbox_damage_received(amount, knockback, from)  â”‚               â”‚
â”‚  â”‚   if invincibility_timer > 0:  â—„â”€â”€â”€ Check iframe                 â”‚               â”‚
â”‚  â”‚       return  â—„â”€â”€â”€ Bá» qua náº¿u Ä‘ang báº¥t tá»­                        â”‚               â”‚
â”‚  â”‚   if current_state == State.DEATH:                               â”‚               â”‚
â”‚  â”‚       return                                                     â”‚               â”‚
â”‚  â”‚   _apply_damage(amount)                                          â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  8. Ãp dá»¥ng damage vÃ  báº­t iframe                                                    â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ player.gd: _apply_damage(15)                                     â”‚               â”‚
â”‚  â”‚   stats.take_damage(15)  â—„â”€â”€â”€ Trá»« HP                             â”‚               â”‚
â”‚  â”‚   invincibility_timer = 0.5  â—„â”€â”€â”€ Báº­t iframe 0.5 giÃ¢y            â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  9. Stats xá»­ lÃ½ vÃ  check death                                                      â”‚
â”‚     â”‚                                                                               â”‚
â”‚     â–¼                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ character_stats.gd: take_damage(15)                              â”‚               â”‚
â”‚  â”‚   current_health -= 15                                           â”‚               â”‚
â”‚  â”‚   emit_signal("health_changed", current_health, max_health)      â”‚               â”‚
â”‚  â”‚   if current_health <= 0:                                        â”‚               â”‚
â”‚  â”‚       emit_signal("died")  â”€â”€â–º player._on_died() â”€â”€â–º die()       â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Iframe System (Player)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              INVINCIBILITY FRAME (IFRAME)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  Má»¥c Ä‘Ã­ch: NgÄƒn Player bá»‹ hit liÃªn tá»¥c, cho thá»i gian pháº£n á»©ng                     â”‚
â”‚                                                                                     â”‚
â”‚  Timeline sau khi nháº­n damage:                                                      â”‚
â”‚                                                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º     â”‚
â”‚  â”‚                                                                        â”‚         â”‚
â”‚  â”‚ HIT!                                                                   â”‚         â”‚
â”‚  â”‚ â–¼                                                                      â”‚         â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚         â”‚
â”‚  â”‚ â”‚              INVINCIBILITY PERIOD (0.5 seconds)                  â”‚   â”‚         â”‚
â”‚  â”‚ â”‚                                                                  â”‚   â”‚         â”‚
â”‚  â”‚ â”‚  â€¢ Player nháº¥p nhÃ¡y (alpha 0.5 â†” 1.0)                           â”‚   â”‚         â”‚
â”‚  â”‚ â”‚  â€¢ Má»i damage bá»‹ bá» qua                                         â”‚   â”‚         â”‚
â”‚  â”‚ â”‚  â€¢ Enemy váº«n cÃ³ thá»ƒ tiáº¿p tá»¥c attack (nhÆ°ng khÃ´ng gÃ¢y damage)    â”‚   â”‚         â”‚
â”‚  â”‚ â”‚                                                                  â”‚   â”‚         â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚         â”‚
â”‚  â”‚                                                                        â”‚ HIT!    â”‚
â”‚  â”‚                                                                        â”‚ OK      â”‚
â”‚  â”‚                                                                        â–¼         â”‚
â”‚  0s                                                                     0.5s        â”‚
â”‚                                                                                     â”‚
â”‚  Code trong _physics_process():                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ if invincibility_timer > 0:                                              â”‚       â”‚
â”‚  â”‚     invincibility_timer -= delta                                         â”‚       â”‚
â”‚  â”‚     # Hiá»‡u á»©ng nháº¥p nhÃ¡y                                                 â”‚       â”‚
â”‚  â”‚     anim.modulate.a = 0.5 if fmod(invincibility_timer * 10, 1.0) > 0.5   â”‚       â”‚
â”‚  â”‚                       else 1.0                                           â”‚       â”‚
â”‚  â”‚ else:                                                                    â”‚       â”‚
â”‚  â”‚     anim.modulate.a = 1.0                                                â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Classes

### HitboxComponent (Area2D)
```gdscript
# VÃ¹ng GÃ‚Y damage
# Layer: PLAYER_HITBOX (7) hoáº·c ENEMY_HITBOX (8)
# Mask: ENEMY_HURTBOX (6) hoáº·c PLAYER_HURTBOX (5)

extends Area2D
class_name HitboxComponent

@export var damage: int = 10
@export var knockback_force: float = 100.0

func activate() -> void:
    monitoring = true

func deactivate() -> void:
    monitoring = false

func _on_area_entered(area: Area2D) -> void:
    if area is HurtboxComponent:
        area.receive_damage(damage, knockback_force, global_position)
```

### HurtboxComponent (Area2D)
```gdscript
# VÃ¹ng NHáº¬N damage
# Layer: PLAYER_HURTBOX (5) hoáº·c ENEMY_HURTBOX (6)
# Mask: ENEMY_HITBOX (8) hoáº·c PLAYER_HITBOX (7)

extends Area2D
class_name HurtboxComponent

signal damage_received(amount: int, knockback: float, from_position: Vector2)

func receive_damage(amount: int, knockback: float, from_position: Vector2) -> void:
    emit_signal("damage_received", amount, knockback, from_position)
```

### HealthComponent (Node)
```gdscript
# Quáº£n lÃ½ HP
# Emit signals khi HP thay Ä‘á»•i hoáº·c cháº¿t

extends Node
class_name HealthComponent

signal health_changed(current: int, maximum: int)
signal died

@export var max_health: int = 100
var current_health: int

func take_damage(amount: int) -> void:
    current_health = max(0, current_health - amount)
    emit_signal("health_changed", current_health, max_health)
    if current_health <= 0:
        emit_signal("died")

func heal(amount: int) -> void:
    current_health = min(max_health, current_health + amount)
    emit_signal("health_changed", current_health, max_health)
```

---

## Sequence Diagram

```
    Player                 Player       Player      Enemy       Enemy        Enemy
    Input                  Hitbox       Hurtbox     Hurtbox     Hitbox       AI
      â”‚                      â”‚            â”‚           â”‚           â”‚            â”‚
      â”‚  attack_pressed      â”‚            â”‚           â”‚           â”‚            â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚           â”‚           â”‚            â”‚
      â”‚                      â”‚            â”‚           â”‚           â”‚            â”‚
      â”‚               activate()          â”‚           â”‚           â”‚            â”‚
      â”‚                      â”‚            â”‚           â”‚           â”‚            â”‚
      â”‚                      â”‚  collision â”‚           â”‚           â”‚            â”‚
      â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚           â”‚           â”‚            â”‚
      â”‚                      â”‚            â”‚           â”‚           â”‚            â”‚
      â”‚                      â”‚            â”‚  receive_ â”‚           â”‚            â”‚
      â”‚                      â”‚            â”‚  damage() â”‚           â”‚            â”‚
      â”‚                      â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚           â”‚            â”‚
      â”‚                      â”‚            â”‚           â”‚           â”‚            â”‚
      â”‚                      â”‚            â”‚           â”‚ damage_   â”‚            â”‚
      â”‚                      â”‚            â”‚           â”‚ received  â”‚            â”‚
      â”‚                      â”‚            â”‚           â”‚ signal    â”‚            â”‚
      â”‚                      â”‚            â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚
      â”‚                      â”‚            â”‚           â”‚           â”‚            â”‚
      â”‚                      â”‚            â”‚           â”‚           â”‚ take_      â”‚
      â”‚                      â”‚            â”‚           â”‚           â”‚ damage()   â”‚
      â”‚                      â”‚            â”‚           â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                      â”‚            â”‚           â”‚           â”‚            â”‚
      â”‚                      â”‚            â”‚           â”‚           â”‚  HP -= X   â”‚
      â”‚                      â”‚            â”‚           â”‚           â”‚            â”‚
      â”‚              deactivate()         â”‚           â”‚           â”‚            â”‚
      â”‚                      â”‚            â”‚           â”‚           â”‚            â”‚
```

---

## Debug Visualization

Cáº£ Player vÃ  Enemy Ä‘á»u cÃ³ `debug_draw_enabled` export Ä‘á»ƒ hiá»ƒn thá»‹:

### Player Debug Draw
- ğŸ”µ VÃ²ng trÃ²n state color (IDLE=cyan, MOVE=xanh lÃ¡, ATTACK=Ä‘á»)
- ğŸ“ ÄÆ°á»ng chá»‰ hÆ°á»›ng nhÃ¬n (last_dir)
- ğŸ’š Velocity vector vá»›i mÅ©i tÃªn
- ğŸŸ¡ Hitbox position khi attack
- ğŸ’™ Iframe indicator khi báº¥t tá»­
- âš« 8 cháº¥m hiá»ƒn thá»‹ cÃ¡c vá»‹ trÃ­ hitbox cÃ³ thá»ƒ

### Enemy (Skeleton) Debug Draw
- ğŸŸ¢ Detection range (150px) - vÃ²ng trÃ²n xanh lÃ¡
- ğŸ”´ Attack range (30px) - vÃ²ng trÃ²n Ä‘á»
- ğŸŸ  ÄÆ°á»ng Ä‘áº¿n player khi chase/attack
- ğŸŸ¡ Hitbox position khi attack
- ğŸ“ ÄÆ°á»ng chá»‰ hÆ°á»›ng nhÃ¬n (last_direction)

---

## Cáº¥u hÃ¬nh quan trá»ng

### Player Stats
| Stat | GiÃ¡ trá»‹ máº·c Ä‘á»‹nh | MÃ´ táº£ |
|------|------------------|-------|
| max_health | 100 | HP tá»‘i Ä‘a |
| move_speed | 100 | Tá»‘c Ä‘á»™ di chuyá»ƒn |
| attack_damage | 10 | Damage má»—i Ä‘Ã²n |
| invincibility_duration | 0.5s | Thá»i gian báº¥t tá»­ |

### Enemy (Skeleton) Stats
| Stat | GiÃ¡ trá»‹ | MÃ´ táº£ |
|------|---------|-------|
| max_health | 50 | HP tá»‘i Ä‘a |
| SPEED | 30 | Tá»‘c Ä‘á»™ patrol |
| CHASE_SPEED | 50 | Tá»‘c Ä‘á»™ Ä‘uá»•i |
| DETECTION_RANGE | 150px | Pháº¡m vi phÃ¡t hiá»‡n |
| ATTACK_RANGE | 30px | Khoáº£ng cÃ¡ch táº¥n cÃ´ng |
| HITBOX_DELAY | 0.8s | Delay trÆ°á»›c khi hitbox active |
| damage | 15 | Damage má»—i Ä‘Ã²n |
| knockback_force | 80 | Lá»±c Ä‘áº©y lÃ¹i |

---

## Troubleshooting

### Player khÃ´ng gÃ¢y damage cho Enemy
1. Check Player Hitbox layer = 7 (PLAYER_HITBOX)
2. Check Player Hitbox mask = 6 (ENEMY_HURTBOX)
3. Check Enemy Hurtbox layer = 6 (ENEMY_HURTBOX)
4. Check Enemy Hurtbox mask = 7 (PLAYER_HITBOX)
5. Äáº£m báº£o `attack_hitbox.activate()` Ä‘Æ°á»£c gá»i
6. Äáº£m báº£o signal `damage_received` Ä‘Æ°á»£c connect

### Enemy khÃ´ng gÃ¢y damage cho Player
1. Check Enemy Hitbox layer = 8 (ENEMY_HITBOX)
2. Check Enemy Hitbox mask = 5 (PLAYER_HURTBOX)
3. Check Player Hurtbox layer = 5 (PLAYER_HURTBOX)
4. Check Player Hurtbox mask = 8 (ENEMY_HITBOX)
5. Check `invincibility_timer` - cÃ³ thá»ƒ Ä‘ang trong iframe
6. Äáº£m báº£o signal `damage_received` Ä‘Æ°á»£c connect

### Collision khÃ´ng hoáº¡t Ä‘á»™ng
1. Äáº£m báº£o Area2D cÃ³ CollisionShape2D vá»›i shape Ä‘Æ°á»£c set
2. Check `monitoring = true` (cho Area2D detect collision)
3. Check `monitorable = true` (cho Area2D cÃ³ thá»ƒ bá»‹ detect)
4. Verify collision layers vÃ  masks khá»›p nhau

---

## File References

| File | MÃ´ táº£ |
|------|-------|
| [sense/entities/player/player.gd](../sense/entities/player/player.gd) | Player controller |
| [sense/entities/player/character_stats.gd](../sense/entities/player/character_stats.gd) | Player stats resource |
| [sense/entities/enemies/skeleton/skeleton.gd](../sense/entities/enemies/skeleton/skeleton.gd) | Skeleton enemy |
| [sense/components/hitbox_component.gd](../sense/components/hitbox_component.gd) | Hitbox component |
| [sense/components/hurtbox_component.gd](../sense/components/hurtbox_component.gd) | Hurtbox component |
| [sense/components/health_component.gd](../sense/components/health_component.gd) | Health component |
| [sense/globals/collision_layers.gd](../sense/globals/collision_layers.gd) | Collision layer constants |
